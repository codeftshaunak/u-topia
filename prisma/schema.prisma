// This is your Prisma schema file
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Enums
enum AffiliateTier {
  bronze
  silver
  gold
  platinum
  diamond
  elite
  legend
  titan
}

enum CommissionStatus {
  pending
  approved
  paid
  reversed
  held
}

enum ReferralStatus {
  pending
  active
  invalid
}

enum RevenueStatus {
  pending
  settled
  reversed
}

enum PaymentProvider {
  fireblocks
  stripe
  manual
}

// Models
model User {
  id                 String         @id @default(cuid())
  email              String         @unique
  password           String
  emailVerified      DateTime?
  fireblocksVaultId  String?        @unique // One-vault-per-user architecture
  currentPackage     AffiliateTier? // Current active package
  packageActivatedAt DateTime?      // When the current package was activated
  referredByUserId   String?        // Who referred this user (permanent chain link)
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt

  // Relations
  referredBy           User?          @relation("UserReferralChain", fields: [referredByUserId], references: [id], onDelete: SetNull)
  referredUsers        User[]         @relation("UserReferralChain")
  profile              Profile?
  affiliateStatus      AffiliateStatus?
  referralLinksCreated ReferralLink[]
  referralsAsReferrer  Referral[]       @relation("ReferrerReferrals")
  referralsAsReferred  Referral[]       @relation("ReferredReferrals")
  commissionsEarned    Commission[]     @relation("BeneficiaryCommissions")
  commissionsFromUser  Commission[]     @relation("ReferredUserCommissions")
  revenueEvents        RevenueEvent[]
  purchases            Purchase[]
  paymentSessions      PaymentSession[]
  referredPurchases    Purchase[]       @relation("ReferredPurchases")

  @@index([referredByUserId])
  @@map("users")
}

model Profile {
  id                       String   @id @default(cuid())
  userId                   String   @unique
  email                    String?
  fullName                 String?
  avatarUrl                String?
  isVerified               Boolean  @default(false)
  lastActive               DateTime?
  notificationPreferences  Json?
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("profiles")
}

model AdminWhitelist {
  id        String    @id @default(cuid())
  email     String    @unique
  isActive  Boolean   @default(true)
  createdBy String?
  updatedBy String?
  createdAt DateTime  @default(now())
  updatedAt DateTime?

  @@map("admin_whitelist")
}

model AdminAuditLog {
  id          String   @id @default(cuid())
  action      String
  adminEmail  String
  targetTable String
  targetId    String?
  before      Json?
  after       Json?
  createdAt   DateTime @default(now())

  @@map("admin_audit_log")
}

model AffiliateStatus {
  userId         String        @id
  tier           AffiliateTier @default(bronze)
  tierDepthLimit Int           @default(1)
  isActive       Boolean       @default(true)
  isTest         Boolean       @default(false)
  updatedAt      DateTime      @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("affiliate_status")
}

model ReferralLink {
  id          String    @id @default(cuid())
  userId      String
  code        String    @unique
  isActive    Boolean   @default(true)
  usedAt      DateTime?
  usedByEmail String?
  createdAt   DateTime  @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("referral_links")
}

model Referral {
  id             String         @id @default(cuid())
  referrerUserId String
  referredUserId String
  status         ReferralStatus @default(pending)
  isTest         Boolean        @default(false)
  verifiedAt     DateTime?
  createdAt      DateTime       @default(now())

  // Relations
  referrer User @relation("ReferrerReferrals", fields: [referrerUserId], references: [id], onDelete: Cascade)
  referred User @relation("ReferredReferrals", fields: [referredUserId], references: [id], onDelete: Cascade)

  @@unique([referrerUserId, referredUserId])
  @@map("referrals")
}

model Commission {
  id                  String           @id @default(cuid())
  beneficiaryUserId   String
  referredUserId      String
  sourceRevenueEventId String
  layer               Int
  ratePercent         Float
  amountUsd           Float
  status              CommissionStatus @default(pending)
  isTest              Boolean          @default(false)
  notes               String?
  createdAt           DateTime         @default(now())

  // Relations
  beneficiary      User         @relation("BeneficiaryCommissions", fields: [beneficiaryUserId], references: [id], onDelete: Cascade)
  referredUser     User         @relation("ReferredUserCommissions", fields: [referredUserId], references: [id], onDelete: Cascade)
  sourceRevenueEvent RevenueEvent @relation(fields: [sourceRevenueEventId], references: [id], onDelete: Cascade)

  @@map("commission_ledger")
}



model RevenueEvent {
  id                String        @id @default(cuid())
  userId            String
  source            String
  amountUsd         Float
  status            RevenueStatus @default(pending)
  isTest            Boolean       @default(false)
  externalReference String?
  occurredAt        DateTime      @default(now())
  settledAt         DateTime?
  createdAt         DateTime      @default(now())

  // Relations
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  commissions Commission[]

  @@map("revenue_events")
}

model Package {
  id               String   @id @default(cuid())
  name             String   @unique
  level            Int      @default(1)        // Package level 1-8 (R1-R8)
  priceUsd         Float
  maxDepth         Int      @default(1)        // Max referral depth this package unlocks
  isActive         Boolean  @default(true)
  updatedBy        String?
  // UniLevel commission levels: [{ level: 1, rate: 10 }, { level: 2, rate: 5 }, ...]
  commissionLevels Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("packages")
}

// Track package upgrades (pay commission only on the price difference)
model PackageUpgrade {
  id              String   @id @default(cuid())
  userId          String
  fromPackage     String   // e.g. "bronze"
  toPackage       String   // e.g. "gold"
  fromPriceUsd    Float
  toPriceUsd      Float
  differenceUsd   Float    // toPriceUsd - fromPriceUsd (commission base)
  purchaseId      String?  // Link to the upgrade purchase
  createdAt       DateTime @default(now())

  @@index([userId])
  @@map("package_upgrades")
}

model Purchase {
  id                     String          @id @default(cuid())
  userId                 String?
  email                  String
  tier                   String
  amount                 Float
  status                 String          @default("pending")
  provider               PaymentProvider @default(fireblocks)
  stripeSessionId        String?
  stripePaymentIntentId  String?
  referralCode           String?         // Referral code used for this package purchase
  referredByUserId       String?         // User who shared the referral link
  isTest                 Boolean         @default(false)
  createdAt              DateTime        @default(now())

  // Relations
  user               User?              @relation(fields: [userId], references: [id], onDelete: SetNull)
  referredByUser     User?              @relation("ReferredPurchases", fields: [referredByUserId], references: [id], onDelete: SetNull)
  paymentSession     PaymentSession?
  transactionHistory TransactionHistory[]

  @@index([referralCode])
  @@index([referredByUserId])
  @@map("purchases")
}

model PaymentSession {
  id              String          @id @default(cuid())
  purchaseId      String          @unique
  userId          String
  email           String
  tier            String
  amountUsd       Float
  assetId         String
  depositAddress  String
  depositTag      String?
  vaultAccountId  String
  externalTxId    String          @unique
  customerRefId   String?         // Reference ID for Fireblocks transaction metadata
  provider        PaymentProvider @default(fireblocks)
  status          String          @default("pending")
  fireblocksStatus String?         // Raw Fireblocks status code (e.g. CONFIRMING, COMPLETED, FAILED)
  fireblocksTxId  String?
  txHash          String?
  amountReceived  Float?
  amountCrypto    String?         // Stored as string for precision
  isTest          Boolean         @default(false)
  expiresAt       DateTime
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  referralCode    String?         // Referral code carried through from checkout

  // Relations
  purchase Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([depositAddress])
  @@index([externalTxId])
  @@index([customerRefId])
  @@index([userId, status])
  @@index([vaultAccountId, status])
  @@map("payment_sessions")
}

model ApprovedRevenueSource {
  id         String   @id @default(cuid())
  sourceName String   @unique
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())

  @@map("approved_revenue_sources")
}

model PlatformActivity {
  id        String   @id @default(cuid())
  eventType String
  userId    String?
  userEmail String?
  status    String   @default("pending")
  amount    Float?
  metadata  Json?
  isTest    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@map("platform_activity")
}

model PlatformSetting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       Json
  description String?
  updatedBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("platform_settings")
}

model TransactionHistory {
  id                 String          @id @default(cuid())
  purchaseId         String
  userId             String?
  provider           PaymentProvider
  transactionId      String          // External transaction ID from provider
  status             String
  subStatus          String?
  eventType          String          // webhook event type
  amount             Float?
  amountUsd          Float?
  networkFee         Float?
  currency           String?
  txHash             String?
  sourceAddress      String?
  destinationAddress String?
  blockHeight        String?
  blockHash          String?
  confirmations      Int?
  note               String?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  // Relations
  purchase Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)

  @@index([purchaseId])
  @@index([transactionId])
  @@index([userId])
  @@map("transaction_history")
}

model ContactSubmission {
  id        String   @id @default(cuid())
  userId    String?  // Optional - can be anonymous
  name      String
  email     String
  subject   String
  message   String
  status    String   @default("new") // new, read, resolved
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("contact_submissions")
}


